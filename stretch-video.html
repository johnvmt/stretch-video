<template>
	<div style="width: 100%; height: 100%; background-color: #ff0000; overflow: hidden"></div>
</template>

<script>
	(function(window, document) {
		// Create references to this file and directory
		var componentDoc =  (document._currentScript || document.currentScript).ownerDocument;
		var componentDir = componentDoc.baseURI.substring(0, componentDoc.baseURI.lastIndexOf('/'));

		// Gets content from <template>
		var template = componentDoc.querySelector('template').content;

		// Creates an object based in the HTML Element prototype
		var ElemProto = Object.create(HTMLElement.prototype);

		// Fires when an instance of the element is created
		ElemProto.createdCallback = function() {
			// Creates the shadow root
			this.shadowRoot = this.createShadowRoot();

			// Adds a template clone into shadow root
			this.shadowRoot.appendChild(document.importNode(template, true));

			// Get the video container (div)
			this.videoContainer = this.shadowRoot.querySelector('div');

			// get and merge params from stretch-video element
			var elementAttributeDefaults = {};
			this.elementAttributes = objectExtend(elementAttributeDefaults, this.getAttributes());

			// Add the video to the container
			this.addVideo(this.elementAttributes, this.videoContainer);

			// resize the player when the parent element is resized
			var self = this;
			window.addEventListener('resize', function() {
				self.resize();
			});
		};

		ElemProto.addVideo = function(videoAttributes, videoContainer) {
			// create the <video> tag
			var videoElem = document.createElement('video');

			// copy attributes to <video>
			for(attributeKey in videoAttributes) {
				if(videoAttributes.hasOwnProperty(attributeKey))
					videoElem[attributeKey] = videoAttributes[attributeKey];
			}

			// resize the video once the video's metadata (size) is loaded
			var self = this;
			videoElem.addEventListener('loadedmetadata', function() {
				// play+pause to overcome Chrome bug
				self.play();
				self.pause();

				self.resize();
			});

			// add the <video> to the <div>
			videoContainer.appendChild(videoElem);
		};

		ElemProto.play = function() {
			var videoElem = this.videoContainer.querySelector('video');
			videoElem.play();
		};

		ElemProto.pause = function() {
			var videoElem = this.videoContainer.querySelector('video');
			videoElem.pause();
		};

		ElemProto.reset = function(time) {
			// TODO add ability to set non-0 start times
			this.setTime(0);
		};

		ElemProto.setTime = function(time) {
			// TODO should be triggered by setting currentTime attribute
			var videoElem = this.videoContainer.querySelector('video');
			videoElem.currentTime = time;
		};
		
		ElemProto.resize = function() {
			var videoContainer = this.videoContainer;
			var videoElem = videoContainer.querySelector('video');
			videoElem.width = videoElem.videoWidth;
			videoElem.height = videoElem.videoHeight;

			videoElem.style.transformOrigin = "top left";
			videoElem.style.transform = "scale(" + videoContainer.offsetWidth / videoElem.videoWidth + ", " + videoContainer.offsetHeight / videoElem.videoHeight + ")";
		};

		// Fires when an attribute was added, removed, or updated
		ElemProto.attributeChangedCallback = function(attr, oldVal, newVal) {

		};

		ElemProto.getAttributes = function() {
			var attributes = {};
			for(var ctr = 0; ctr < this.attributes.length; ctr++) {
				attributes[this.attributes[ctr].nodeName] = this.attributes[ctr].nodeValue;
			}
			return attributes;
		};

		// Utility Functions
		function objectExtend() {
			var merged = {};
			objectForEach(arguments, function(argument) {
				for (var attrname in argument) {
					if(argument.hasOwnProperty(attrname))
						merged[attrname] = argument[attrname];
				}
			});
			return merged;

			function objectForEach(object, callback) {
				// run function on each property (child) of object
				var property;
				for(property in object) { // pull keys before looping through?
					if (object.hasOwnProperty(property))
						callback(object[property], property, object);
				}
			}
		}

		window.StretchVideo = document.registerElement('stretch-video', {
			prototype: ElemProto
		});
	})(window, document);
</script>

<template>
	<style>
		.me-plugin {width: 100%; height: 100%;}
		.mejs-offscreen { display: none; }
		.mejs-container{
			width: 100% !important;
			height: 100% !important;
		}
		.mejs-layers .mejs-layer{
			width: 100% !important;
			height: 100% !important;
		}
	</style>
	<div style="width: 100%; height: 100%; background-color: #ff0000; overflow: hidden"></div>
</template>

<!-- Mediaelement -->
<script src="mediaelement/jquery.min.js"></script>
<script src="mediaelement/mediaelement-and-player.min.js"></script>
<link rel="stylesheet" href="mediaelement/mediaelementplayer.min.css" />

<script>
	(function(window, document) {
		// this file
		var componentDoc =  (document._currentScript || document.currentScript).ownerDocument;
		var componentDir = componentDoc.baseURI.substring(0, componentDoc.baseURI.lastIndexOf('/'));

		// Gets content from <template>
		var template = componentDoc.querySelector('template').content;

		// Creates an object based in the HTML Element prototype
		var ElemProto = Object.create(HTMLElement.prototype);

		// Fires when an instance of the element is created
		ElemProto.createdCallback = function() {
			var self = this;

			// Creates the shadow root
			self.shadowRoot = self.createShadowRoot();

			// Adds a template clone into shadow root
			self.shadowRoot.appendChild(document.importNode(template, true));

			// Get the video container (div)
			self.videoContainer = self.shadowRoot.querySelector('div');

			// get params from datastore-video element
			var elementAttributes = {};

			for(var ctr = 0; ctr < this.attributes.length; ctr++) {
				elementAttributes[this.attributes[ctr].nodeName] = this.attributes[ctr].nodeValue;
			}

			var meParamsDefault = {
				pluginPath: componentDir + '/mediaelement/', // path to Flash and Silverlight plugins
				success: function(mediaElement, domObject) {
					self.mediaElement = mediaElement;
					console.log("SUCCESS");
					/* mediaElement.play(); */
					//mediaElement.setVolume(0);
				},
				error: function () {
					console.log("ERR");
				}
			};

			$(self.shadowRoot).ready(function() {
				createPlayer(self.videoContainer, elementAttributes, meParamsDefault, self.shadowRoot);
			});

			window.addEventListener('resize', function() {
				resizePlayer(self.videoContainer);
				// This works for hls: addPlayer(target, elementAttributes, meParamsDefault, shadowRoot);
			});
		};

		// Fires when an attribute was added, removed, or updated
		ElemProto.attributeChangedCallback = function(attr, oldVal, newVal) {

		};

		ElemProto.play = function() {
			console.log("PLAY");
			try {
				self.mediaElement.play()
			}
			catch(error) {


			}
		};

		function resizePlayer(videoContainer) {

			if(videoContainer.getElementsByTagName('embed').length) { // using flash fallback
				/* var videoElem = videoContainer.querySelector('embed');
				videoElem.style.transformOrigin = "top left";
				console.log(videoContainer.offsetWidth, parseInt(videoElem.width), videoContainer.offsetWidth / parseInt(videoElem.width));
				console.log(videoContainer.offsetHeight, parseInt(videoElem.height), videoContainer.offsetHeight / parseInt(videoElem.height));
				videoElem.style.transform = "scale(" + videoContainer.offsetWidth / videoElem.width + ", " + videoContainer.offsetHeight / videoElem.height + ")"; */
			}
			else { // native HTML5 video
				var videoElem = videoContainer.querySelector('video');
				videoElem.width = videoElem.videoWidth;
				videoElem.height = videoElem.videoHeight;

				// videoContainer.style.overflow = "hidden";
				videoElem.style.transformOrigin = "top left";
				videoElem.style.transform = "scale(" + videoContainer.offsetWidth / videoElem.videoWidth + ", " + videoContainer.offsetHeight / videoElem.videoHeight + ")";
			}
		}

		function createPlayer(rootElem, videoParams, meParams, rootDoc) {
			// merge parameters for video element
			var videoExt = videoParams.src.split('.').pop();

			var videoParamsDefault = {
				type: videoExt == "m3u8" ? "application/x-mpegURL" : "video/" + videoExt,
				width: rootElem.offsetWidth,
				height: rootElem.offsetHeight
			};
			$.extend(videoParamsDefault, videoParams);

			console.log(videoParamsDefault);

			// merge parameters for mediaelement
			var meParamsDefault = {
				defaultVideoWidth: rootElem.offsetWidth,
				defaultVideoHeight: rootElem.offsetHeight,
				enableAutosize: false
			};

			$.extend(meParamsDefault, meParams);

			if(typeof videoParamsDefault['muted'] != "undefined")
				meParamsDefault['startVolume'] = 0;

			// clear any old players
			rootElem.innerHTML = "";

			// create and attach the video element
			var videoElem = document.createElement('video');
			for (var key in videoParamsDefault) {
				if (videoParamsDefault.hasOwnProperty(key))
					videoElem.setAttribute(key, videoParamsDefault[key]);
			}

			videoElem.addEventListener("loadedmetadata", function() {
				resizePlayer(rootElem);
			});

			rootElem.appendChild(videoElem);

			console.log(meParamsDefault);

			// create the mediaelement player
			return new MediaElement(videoElem, meParamsDefault, rootDoc);
		}

		window.StretchVideo = document.registerElement('stretch-video', {
			prototype: ElemProto
		});
	})(window, document);
</script>
